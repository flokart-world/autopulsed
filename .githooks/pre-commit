#!/bin/bash
# Pre-commit hook to ensure code quality
# To use: git config core.hooksPath .githooks

echo "üîç Running pre-commit checks..."

# Check for unstaged changes and untracked Rust files
if git diff --name-only | grep -q "\.rs$"; then
    echo "‚ùå Unstaged changes detected in Rust files."
    echo "   Please stage all Rust changes before committing."
    echo "   This ensures cargo fmt checks the correct content."
    exit 1
fi

if git ls-files --others --exclude-standard | grep -q "\.rs$"; then
    echo "‚ùå Untracked Rust files detected."
    echo "   Please stage or remove untracked Rust files before committing."
    echo "   This ensures cargo fmt checks all relevant files."
    exit 1
fi

# Check formatting
echo "Checking Rust formatting..."
if ! cargo fmt -- --check; then
    echo "‚ùå Formatting errors found. Run 'cargo fmt' to fix."
    exit 1
fi

# Run clippy
echo "Running clippy..."
if ! cargo clippy -- -D warnings 2>/dev/null; then
    echo "‚ùå Clippy warnings found. Fix them before committing."
    exit 1
fi

# Check file formatting on staged content
echo "Checking file formatting..."
HAS_ERRORS=false

# Check staged files only
for file in $(git diff --cached --name-only); do
    # Skip deleted files
    if [ ! -f "$file" ]; then
        continue
    fi
    
    # Only check relevant file types
    case "$file" in
        *.rs|*.toml|*.yml|*.md)
            # Check staged content for trailing spaces
            if git show ":$file" 2>/dev/null | grep -q " $"; then
                echo "‚ùå Trailing spaces in: $file"
                HAS_ERRORS=true
            fi
            
            # Check staged content for missing final newline
            if [ -n "$(git show ":$file" 2>/dev/null | tail -c 1)" ]; then
                echo "‚ùå Missing final newline in: $file"
                HAS_ERRORS=true
            fi
            ;;
    esac
done

if [ "$HAS_ERRORS" = true ]; then
    echo ""
    echo "‚ö†Ô∏è  Format errors found in staged files."
    echo "   Please fix the issues and stage the changes again."
    echo "   Tip: You can use 'sed -i \"s/[[:space:]]*$//' <file>' to remove trailing spaces"
    echo "        and 'echo >> <file>' to add a final newline"
    exit 1
fi

echo "‚úÖ All pre-commit checks passed!"